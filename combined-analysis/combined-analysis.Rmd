---
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    highlight: zenburn
    theme: flatly
header-includes:
   - \usepackage{amsmath}
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(tidy=TRUE, highlight=TRUE, dev="png",
               cache=TRUE, highlight=TRUE, autodep=TRUE, warning=FALSE, error=FALSE,
               message=FALSE, prompt=TRUE, comment='', fig.cap='')
```

# Combined analysis
We are going to combine the samples that were run in February and the samples
that were run in April to have more samples to increase our power to find
differences between the samples.

```{r load-deseq-objects}
load("april.RData")
load("february.RData")
library(DESeq2)
aprcounts = counts(aprdds, normalized=FALSE)
aprsummary = colData(aprdds)
febcounts = counts(febdds, normalized=FALSE)
febsummary = colData(febdds)
```

The sample data is coded a little bit different for both runs, so we will have
to normalize them so they are the same. We will first drop everything except
the metadata from the summary dataframes.

```{r small-summary}
febsum = febsummary[, c("samplename", "fraction", "treatment", "group",
                        "phenotype")]
aprsum = aprsummary[, c("Name", "condition", "treatment", "patient")]
```

Now we need to recode some of the columns. We'll add a 'phenotype' column
to the April data.

```{r add-phenotype-column}
aprsum$phenotype = ifelse(aprsum$condition == "HC", "noMS", "MS")
```

We'll recode the treatment factors to be `L` for `LPS` and `LI` for `LPS+IL27`
and `U` for untreated to avoid using a plus. We'll also rename the `patient`
column to `group` for the April samples and add a `a` or `f` prefix to make the
groups unique across months. Finally we add a column for which month the
sequencing was done.

```{r recode-treatment-columns}
aprsum$treat = ifelse(aprsum$treatment == "LPS", "L", "LI")
febsum$treat = ifelse(febsum$treatment == "LPS", "L",
               ifelse(febsum$treatment == "natural", "U", "LI"))
aprsum$group = aprsum$patient
febmeta = febsum[, c("group", "treat", "phenotype")]
aprmeta = aprsum[, c("group", "treat", "phenotype")]
febmeta$month = "feb"
aprmeta$month = "apr"
febmeta$group = paste0("f", febmeta$group)
aprmeta$group = paste0("a", aprmeta$group)
```

Now we can combine the metadata and the counts, replace missing values with 0
and reorder the metadata and the counts so they are in the same order. We'll
also drop the untreated samples since we don't have those in the April run
and that causes some issues in convergence.

```{r final-combine}
library(dplyr)
melted = rbind(reshape2::melt(aprcounts), reshape2::melt(febcounts))
colnames(melted) = c("gene", "sample", "count")
combined = melted %>% tidyr::spread(sample, count) %>% as.data.frame()
rownames(combined) = combined$gene
combined$gene = NULL
combined[is.na(combined)] = 0
counts = combined
metadata = rbind(febmeta, aprmeta)
metadata$group = as.factor(metadata$group)
metadata$treat = relevel(as.factor(metadata$treat), ref="U")
metadata$phenotype = relevel(as.factor(metadata$phenotype), ref="noMS")
counts = counts[, rownames(metadata)]
```

And pull in the gene symbols from biomaRt.

```{r biomart-symbols}
mart = biomaRt::useMart(biomart = "ensembl", dataset = "hsapiens_gene_ensembl")
symbols <- biomaRt::getBM(attributes = c("ensembl_gene_id",
                                         "external_gene_name", "hgnc_symbol"),
                          mart=mart)
```

And we're good to go.

# Differential expresssion

We fit a model looking only within patients that are in the same `group`, since
they are matched. Then we fit a term for `phenotype`, `treatment` and an
interaction term between `phenotype` and `treatment` so we can look at the
specific effects of each treatment. We fit this model:

$$Y \sim group + treat + pheno + pheno:treat$$

Which expands to:

$$Y \sim \beta_0 + \beta_{1}x_{1} + \beta_{2}x_{2} + \beta_{3}x_{3} +
\beta_{4}x_{1}x_{3} + \beta_{5}x_{2}x_{3}$$

where

$x_{1} = \left\{
\begin{array}{ll}
      1 & \text{treat is L} \\
      0 & \text{otherwise} \\
\end{array}
\right.$

$x_{2} = \left\{
\begin{array}{ll}
      1 & \text{treat is I} \\
      0 & \text{otherwise} \\
\end{array}
\right.$

$x_{3} = \left\{
\begin{array}{ll}
      1 & \text{pheno is noMS} \\
      0 & \text{otherwise} \\
\end{array}
\right.$

This gives the following meaning to the coefficients:

$\beta_{0} = \text{baseline expression in untreated, non MS cells}$

$\beta_{1} = \text{effect of L treatment on non-MS cells}$

$\beta_{2} = \text{effect of I treatment on non-MS cells}$

$\beta_{3} = \text{effect of MS on untreated cells}$

$\beta_{4} = \text{specific effect of L treatment on MS cells}$

$\beta_{5} = \text{specific effect of I treatment on MS cells}$

```{r fit-model}
design = ~group+treat+phenotype+phenotype:treat
dds = DESeqDataSetFromMatrix(countData=counts, colData=metadata, design=design)
dds = estimateSizeFactors(dds)
dds = DESeq(dds)
plotDispEsts(dds)
```

## MS vs nonMS
Here we looking at the difference between the `MS` and `noMS` cells,
when the cells are untreated. We are testing the significance of `$\beta_{3}$`
listed above.

Positive $log_{2}$ fold changes are higher in the `MS untreated`
samples than the `noMS untreated` samples.
`
We can see from the MA plot some evidence that there are a set of genes
expressed at a low levels that are preferentially on or off in the MS cells.

```{r ms-effects}
library(dplyr)
mseffect = results(dds, name="phenotype_MS_vs_noMS")
plotMA(mseffect, ylim=c(-35,35))
title("MS effect")
mseffect = mseffect %>% as.data.frame() %>%
  add_rownames() %>%
  rename(gene=rowname) %>%
  left_join(symbols, by=c("gene"="ensembl_gene_id"))  %>%
  arrange(padj)
write.table(mseffect, file="mseffect.csv", row.names=FALSE,
            col.names=TRUE, quote=FALSE, sep=",")
```

## Effect of L treatment on noMS samples
Here we look at the difference between the `L` treated `noMS` samples
and the untreated noMS samples. We are testing the significance of
$\beta_{1}$ above.

Positive $log_{2}$ fold changes are higher in the `noMS LPS` treated
samples than the `noMS untreated` samples.

```{r l-noMS}
lps_nomseffect = results(dds, name="treat_L_vs_U")
plotMA(lps_nomseffect, ylim=c(-35,35))
title("L treatment on noMS cells")
lps_nomseffect = lps_nomseffect %>% as.data.frame() %>%
  add_rownames() %>%
  rename(gene=rowname) %>%
  left_join(symbols, by=c("gene"="ensembl_gene_id"))  %>%
  arrange(padj)
write.table(lps_nomseffect, file="lps_nomseffect.csv", row.names=FALSE,
            col.names=TRUE, quote=FALSE, sep=",")
```

## Effect of LI treatment on noMS samples
Here we look at the difference between the `LI treated noMS` samples
and the `untreated noMS` samples. We are testing $\beta_{2}$ above.

Positive $log_{2}$ fold changes are higher in the `LI treated noMS`
samples than the `noMS untreated` samples.

```{r li-noMS}
li_nomseffect = results(dds, name="treat_LI_vs_U")
plotMA(li_nomseffect, ylim=c(-35,35))
title("LI treatment on noMS cells")
li_nomseffect = li_nomseffect %>% as.data.frame() %>%
  add_rownames() %>%
  rename(gene=rowname) %>%
  left_join(symbols, by=c("gene"="ensembl_gene_id"))  %>%
  arrange(padj)
write.table(li_nomseffect, file="li_nomseffect.csv", row.names=FALSE,
            col.names=TRUE, quote=FALSE, sep=",")
```

## Specific effect of L treatment on MS samples
Here we look at the specific effect that treating with LPS has on the MS samples.
We are testing the $\beta_{4}$ coefficient above.

```{r l-ms-effect}
l_mseffect = results(dds, name="treatL.phenotypeMS")
plotMA(l_mseffect, ylim=c(-35,35))
title("L treatment on MS cells")
l_mseffect = l_mseffect %>% as.data.frame() %>%
  add_rownames() %>%
  rename(gene=rowname) %>%
  left_join(symbols, by=c("gene"="ensembl_gene_id"))  %>%
  arrange(padj)
write.table(l_mseffect, file="l_mseffect.csv", row.names=FALSE,
            col.names=TRUE, quote=FALSE, sep=",")
```

## Specific effect of LI treatment on MS samples
Finally we look at the specific effect that treating with LPS+IL27 has on the
MS samples. We are testing the $\beta_{5}$ coefficient above.

```{r li-ms-effect}
li_mseffect = results(dds, name="treatLI.phenotypeMS")
plotMA(li_mseffect, ylim=c(-35,35))
title("LI treatment on MS cells")
li_mseffect = li_mseffect %>% as.data.frame() %>%
  add_rownames() %>%
  rename(gene=rowname) %>%
  left_join(symbols, by=c("gene"="ensembl_gene_id"))  %>%
  arrange(padj)
write.table(li_mseffect, file="li_mseffect.csv", row.names=FALSE,
            col.names=TRUE, quote=FALSE, sep=",")
```
